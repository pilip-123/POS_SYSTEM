{% extends 'base.html' %}
{% block title %}Categories{% endblock %}
{% block content %}
<div class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold text-gray-800">Categories</h1>
  <button id="open-add-modal" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Category</button>
</div>

<div id="categories-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

<dialog id="category-modal">
  <form id="category-form" class="space-y-4 p-4">
    <input type="hidden" id="category-id">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
      <input id="category-name" required class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="flex justify-end gap-2">
      <button type="button" id="cancel-modal" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
    </div>
  </form>
</dialog>

<script>
  const modal = document.getElementById('category-modal');
  const form = document.getElementById('category-form');
  const grid = document.getElementById('categories-grid');
  const openAdd = document.getElementById('open-add-modal');
  const cancel = document.getElementById('cancel-modal');

  async function loadCategories() {
    const res = await fetch('/api/categories');
    const cats = await res.json();
    grid.innerHTML = '';
    cats.forEach(c => grid.appendChild(createCard(c)));
  }

  function createCard(c) {
    const div = document.createElement('div');
    div.className = 'card bg-white rounded-xl shadow-md p-6 animate-scale-in';
    div.dataset.id = c.id;
    div.innerHTML = `
      <h3 class="text-xl font-semibold text-gray-800 mb-4">${c.name}</h3>
      <div class="flex gap-2">
        <button data-id="${c.id}" class="edit-btn bg-yellow-500 text-white px-3 py-1 rounded flex-1 hover:bg-yellow-600">Edit</button>
        <button data-id="${c.id}" class="delete-btn bg-red-600 text-white px-3 py-1 rounded flex-1 hover:bg-red-700">Delete</button>
      </div>
    `;
    return div;
  }

  openAdd.onclick = () => { form.reset(); document.getElementById('category-id').value = ''; modal.showModal(); };
  cancel.onclick = () => modal.close();

  form.onsubmit = async e => {
    e.preventDefault();
    const id = document.getElementById('category-id').value;
    const data = { name: document.getElementById('category-name').value };
    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/categories/${id}` : '/api/categories';
    const res = await fetch(url, { method, headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
    if (res.ok) {
      const cat = await res.json();
      if (id) {
        const card = grid.querySelector(`[data-id="${id}"]`);
        card.querySelector('h3').textContent = cat.name;
      } else {
        grid.appendChild(createCard(cat));
      }
      modal.close();
    }
  };

  grid.addEventListener('click', async e => {
    const btn = e.target;
    const id = btn.dataset.id;
    const card = btn.closest('[data-id]');
    if (btn.classList.contains('edit-btn')) {
      const res = await fetch(`/api/categories/${id}`);
      const cat = await res.json();
      document.getElementById('category-id').value = cat.id;
      document.getElementById('category-name').value = cat.name;
      modal.showModal();
    } else if (btn.classList.contains('delete-btn')) {
      if (confirm('Delete this category?')) {
        await fetch(`/api/categories/${id}`, { method: 'DELETE' });
        card.remove();
      }
    }
  });

  loadCategories();
</script>
{% endblock %}