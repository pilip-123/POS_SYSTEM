<!-- templates/billing.html -->
{% extends 'base.html' %}
{% block title %}Billing{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-10 space-y-10">

  <!-- HEADER -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-4xl font-bold text-gray-900 flex items-center gap-3">
        <svg class="w-9 h-9 text-indigo-600" fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M3 10h11M9 21V3m0 0l3 3m-3-3l-3 3" />
        </svg>
        Billing
      </h1>
      <p class="text-gray-500 mt-1 text-sm">Quickly add items and confirm your sale.</p>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="grid lg:grid-cols-3 gap-10">

    <!-- PRODUCTS -->
    <div class="lg:col-span-2 bg-white border border-gray-100 rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-5">
        <h2 class="text-2xl font-semibold text-gray-800">Products</h2>
        <input type="text" id="search-products" placeholder="Search..."
               class="border rounded-lg px-3 py-2 text-sm w-48 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
      </div>

      <div id="products-list"
           class="grid sm:grid-cols-2 xl:grid-cols-3 gap-6 max-h-[75vh] overflow-y-auto pr-2 custom-scroll">
      </div>
    </div>

    <!-- CART -->
    <div class="bg-white border border-gray-100 rounded-2xl shadow-lg p-6 flex flex-col h-fit sticky top-10">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <svg class="w-5 h-5 text-emerald-600" fill="none" stroke="currentColor" stroke-width="2"
             viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round"
                d="M5 13l4 4L19 7" />
        </svg>
        Cart
      </h2>

      <div class="border rounded-xl overflow-hidden mb-4">
        <table class="w-full text-sm">
          <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
            <tr>
              <th class="p-2 text-left">Product</th>
              <th class="p-2 text-center">Qty</th>
              <th class="p-2 text-right">Subtotal</th>
              <th class="p-2"></th>
            </tr>
          </thead>
          <tbody id="cart-body" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>

      <!-- TOTAL -->
      <div class="flex justify-between items-center border-t pt-3 mb-5">
        <span class="text-lg font-semibold text-gray-700">Total:</span>
        <span class="text-3xl font-bold text-indigo-700" id="cart-total">$0.00</span>
      </div>

      <!-- CUSTOMER -->
      <div class="mb-4">
        <label for="customer-select" class="text-sm text-gray-600 mb-2 block font-medium">Customer</label>
        <select id="customer-select"
                class="border border-gray-300 rounded-lg w-full p-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
          <option value="">Guest</option>
        </select>
      </div>

      <!-- CONFIRM BUTTON -->
      <button id="confirm-sale"
              class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white py-3 rounded-lg text-lg font-semibold shadow-md hover:shadow-lg hover:scale-[1.02] transition-all">
        Confirm Sale
      </button>
    </div>
  </div>
</div>

<!-- STYLES -->
<style>
  .custom-scroll::-webkit-scrollbar {
    width: 6px;
  }
  .custom-scroll::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 3px;
  }
</style>

<!-- SCRIPT – ONLY 3 LINES FIXED -->
<script>
  let cart = [];
  const productsList = document.getElementById('products-list');
  const cartBody = document.getElementById('cart-body');
  const cartTotal = document.getElementById('cart-total');
  const customerSelect = document.getElementById('customer-select');
  const searchInput = document.getElementById('search-products');

  async function loadData() {
    const [prodRes, custRes] = await Promise.all([
      fetch('/api/products'),
      fetch('/api/customers')
    ]);
    const products = await prodRes.json();
    const customers = await custRes.json();

    renderProducts(products);

    customers.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.name;
      customerSelect.appendChild(opt);
    });

    searchInput.addEventListener('input', e => {
      const term = e.target.value.toLowerCase();
      const filtered = products.filter(p => p.name.toLowerCase().includes(term));
      renderProducts(filtered);
    });
  }

  function renderProducts(products) {
    productsList.innerHTML = '';
    if (products.length === 0) {
      productsList.innerHTML = '<p class="text-gray-500 col-span-full text-center py-10">No products found.</p>';
      return;
    }

    products.forEach(p => {
      const div = document.createElement('div');
      div.className =
        'group bg-white border border-gray-100 rounded-xl shadow-sm hover:shadow-lg transition-transform hover:scale-[1.03] flex flex-col overflow-hidden';
      div.innerHTML = `
        <div class="relative">
          <img src="${p.image ? '/static/uploads/' + p.image : '/static/no-image.png'}" alt="${p.name}"
               class="w-full h-36 object-cover group-hover:opacity-90 transition"
               onerror="this.src='/static/no-image.png'">
          <span class="absolute top-2 right-2 bg-white text-xs font-medium px-2 py-0.5 rounded shadow-sm text-gray-700">Stock: ${p.stock}</span>
        </div>
        <div class="flex flex-col flex-1 p-4 justify-between">
          <div>
            <h3 class="font-semibold text-gray-800 text-lg truncate">${p.name}</h3>
            <p class="text-indigo-600 font-bold mt-1">$${p.price.toFixed(2)}</p>
          </div>
          <div class="mt-3 flex items-center gap-2">
            <input type="number" id="qty-${p.id}" min="1" max="${p.stock}"
              class="border rounded-lg px-2 py-1 w-20 text-sm focus:ring-2 focus:ring-indigo-500"
              placeholder="Qty">
            <button class="add-to-cart flex-1 bg-indigo-600 text-white py-1.5 rounded-md text-sm font-medium hover:bg-indigo-700 transition"
              data-id="${p.id}"
              data-name="${p.name}"
              data-price="${p.price}"
              data-stock="${p.stock}">
              Add
            </button>
          </div>
        </div>`;
      productsList.appendChild(div);
    });
  }

  function updateCart() {
    cartBody.innerHTML = '';
    let total = 0;
    cart.forEach(item => {
      const sub = item.price * item.qty;
      total += sub;
      const row = document.createElement('tr');
      row.className = 'hover:bg-gray-50';
      row.innerHTML = `
        <td class="p-2 text-sm text-gray-800">${item.name}</td>
        <td class="p-2 text-center text-sm">${item.qty}</td>
        <td class="p-2 text-right text-sm font-semibold text-gray-700">$${sub.toFixed(2)}</td>
        <td class="p-2 text-center">
          <button class="remove-btn text-red-600 hover:text-red-800 text-base font-bold" data-id="${item.id}">×</button>
        </td>`;
      cartBody.appendChild(row);
    });
    cartTotal.textContent = '$' + total.toFixed(2);
  }

  // Add to Cart
  productsList.addEventListener('click', e => {
    if (e.target.classList.contains('add-to-cart')) {
      const btn = e.target;
      const id = btn.dataset.id;
      const qtyInput = document.getElementById(`qty-${id}`);
      const qty = parseInt(qtyInput.value) || 0;

      if (qty < 1 || qty > parseInt(btn.dataset.stock)) {
        alert('Invalid quantity or out of stock!');
        return;
      }

      const existing = cart.find(i => i.id === id);
      if (existing) {
        if (existing.qty + qty > parseInt(btn.dataset.stock)) {
          alert('Not enough stock!');
          return;
        }
        existing.qty += qty;
      } else {
        cart.push({
          id,
          name: btn.dataset.name,
          price: parseFloat(btn.dataset.price),
          qty
        });
      }

      qtyInput.value = '';
      updateCart();
    }
  });

  // Remove from cart
  cartBody.addEventListener('click', e => {
    if (e.target.classList.contains('remove-btn')) {
      const id = e.target.dataset.id;
      cart = cart.filter(i => i.id !== id);
      updateCart();
    }
  });

  // Confirm Sale – FIXED: send quantity + price
  document.getElementById('confirm-sale').onclick = async () => {
    if (cart.length === 0) return alert('Your cart is empty!');

    const items = cart.map(i => ({
      product_id: parseInt(i.id),
      quantity: i.qty,
      price: i.price
    }));

    const customer_id = customerSelect.value ? parseInt(customerSelect.value) : null;

    try {
      const res = await fetch('/api/sales', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customer_id, items })
      });

      if (res.ok) {
        const { id } = await res.json();
        cart = [];
        updateCart();
        window.location = `/receipt/${id}`;
      } else {
        const err = await res.json();
        alert(err.error || 'Sale failed!');
      }
    } catch {
      alert('Network error. Please try again.');
    }
  };

  loadData();
</script>
{% endblock %}