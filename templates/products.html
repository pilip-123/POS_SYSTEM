{% extends 'base.html' %}
{% block title %}Products{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-indigo-50 py-10">
  <div class="max-w-7xl mx-auto px-6">

    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
      <div>
        <h1 class="text-4xl font-extrabold text-gray-900 flex items-center gap-3">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-1.5 9M4 7l1.5 9m3-9h9m-9 0l1.5 9m6-9l-1.5 9" />
          </svg>
          Products
        </h1>
        <p class="text-gray-500 mt-1">Manage your inventory with ease</p>
      </div>
      <button id="open-add-modal" class="mt-4 sm:mt-0 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-6 py-3 rounded-xl font-semibold shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Product
      </button>
    </div>

    <!-- Products Grid -->
    <div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

    <!-- Empty State -->
    <div id="empty-state" class="hidden text-center py-20">
      <svg class="w-20 h-20 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-1.5 9M4 7l1.5 9m3-9h9m-9 0l1.5 9m6-9l-1.5 9" />
      </svg>
      <p class="text-xl font-medium text-gray-500 mt-4">No products yet</p>
      <p class="text-gray-400">Click "Add Product" to get started</p>
    </div>

  </div>
</div>

<!-- Modal -->
<dialog id="product-modal" class="rounded-2xl shadow-2xl p-0 max-w-lg w-full backdrop:bg-black/50">
  <form id="product-form" enctype="multipart/form-data" class="p-6 space-y-5">
    <h2 class="text-2xl font-bold text-gray-800">Product Details</h2>
    
    <input type="hidden" id="product-id">

    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-1">Name</label>
      <input id="product-name" name="name" required class="w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
    </div>

    <div class="grid grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Price</label>
        <input id="product-price" name="price" type="number" step="0.01" required class="w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
      </div>
      <div>
        <label class="block text-sm font-semibold text-gray-700 mb-1">Stock</label>
        <input id="product-stock" name="stock" type="number" required class="w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
      </div>
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-1">Category</label>
      <select id="product-category" name="category_id" class="w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
        <option value="">None</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
      <textarea id="product-description" name="description" rows="3" class="w-full rounded-lg border border-gray-300 px-4 py-2.5 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"></textarea>
    </div>

    <div>
      <label class="block text-sm font-semibold text-gray-700 mb-1">Image</label>
      <input type="file" name="image" accept="image/*" class="w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <div id="current-image" class="mt-3"></div>
    </div>

    <div class="flex justify-end gap-3 pt-4 border-t">
      <button type="button" id="cancel-modal" class="px-6 py-2.5 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition-all">Cancel</button>
      <button type="submit" class="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition-all">Save Product</button>
    </div>
  </form>
</dialog>

<script>
  // === ELEMENTS ===
  const modal = document.getElementById('product-modal');
  const form = document.getElementById('product-form');
  const grid = document.getElementById('products-grid');
  const emptyState = document.getElementById('empty-state');
  const openAdd = document.getElementById('open-add-modal');
  const cancel = document.getElementById('cancel-modal');
  const categorySelect = document.getElementById('product-category');

  // === LOAD CATEGORIES ===
  async function loadCategories() {
    try {
      const res = await fetch('/api/categories');
      const cats = await res.json();
      categorySelect.innerHTML = '<option value="">None</option>';
      cats.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        categorySelect.appendChild(opt);
      });
    } catch (err) {
      console.error('Failed to load categories:', err);
    }
  }

  // === LOAD PRODUCTS ===
  async function loadProducts() {
    try {
      const res = await fetch('/api/products');
      const prods = await res.json();
      grid.innerHTML = '';
      
      if (prods.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      }
      emptyState.classList.add('hidden');

      prods.forEach(p => {
        const card = createCard(p);
        grid.appendChild(card);
      });
    } catch (err) {
      console.error('Failed to load products:', err);
      showToast('Failed to load products', 'error');
    }
  }

  // === CREATE PRODUCT CARD ===
  function createCard(p) {
    const div = document.createElement('div');
    div.className = 'product-card bg-white rounded-2xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1';
    div.dataset.id = p.id;

    const imgSrc = p.image ? `/static/uploads/${p.image}` : '/static/no-image.png';

    div.innerHTML = `
      <div class="relative">
        <img src="${imgSrc}" alt="${p.name}" class="w-full h-48 object-cover" onerror="this.src='/static/no-image.png'">
        <div class="absolute top-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded-full">Stock: ${p.stock}</div>
      </div>
      <div class="p-5">
        <h3 class="text-xl font-bold text-gray-900 truncate">${p.name}</h3>
        <p class="text-3xl font-bold text-green-600 mt-1">$${p.price.toFixed(2)}</p>
        <p class="text-sm text-gray-600 mt-1">Category: <span class="font-medium">${p.category_name || 'None'}</span></p>
        <p class="text-sm text-gray-500 mt-2 line-clamp-2">${p.description || 'No description'}</p>
        
        <div class="mt-4 flex gap-2">
          <button data-id="${p.id}" class="edit-btn flex-1 bg-gradient-to-r from-yellow-500 to-amber-500 hover:from-yellow-600 hover:to-amber-600 text-white px-4 py-2.5 rounded-lg font-medium shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
            Edit
          </button>
          <button data-id="${p.id}" class="delete-btn flex-1 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white px-4 py-2.5 rounded-lg font-medium shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Delete
          </button>
        </div>
      </div>
    `;
    return div;
  }

  // === TOAST NOTIFICATION ===
  function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
      position: fixed; bottom: 24px; right: 24px; z-index: 1000;
      padding: 16px 24px; border-radius: 12px; font-weight: 600;
      color: white; box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      transform: translateX(400px); transition: transform 0.4s ease;
    `;
    toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
    document.body.appendChild(toast);
    setTimeout(() => toast.style.transform = 'translateX(0)', 50);
    setTimeout(() => {
      toast.style.transform = 'translateX(400px)';
      setTimeout(() => toast.remove(), 400);
    }, 3000);
  }

  // === MODAL OPEN / CLOSE ===
  openAdd.onclick = () => {
    loadCategories();
    form.reset();
    document.getElementById('product-id').value = '';
    document.getElementById('current-image').innerHTML = '';
    modal.showModal();
  };

  cancel.onclick = () => modal.close();
  modal.addEventListener('click', e => {
    if (e.target === modal) modal.close();
  });

  // === FORM SUBMIT (ADD / EDIT) ===
  form.onsubmit = async e => {
    e.preventDefault();
    const id = document.getElementById('product-id').value;
    const formData = new FormData(form);
    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/products/${id}` : '/api/products';

    try {
      const res = await fetch(url, { method, body: formData });
      if (!res.ok) throw new Error('Failed to save');
      
      const p = await res.json();
      
      if (id) {
        const oldCard = grid.querySelector(`[data-id="${id}"]`);
        const newCard = createCard(p);
        oldCard.replaceWith(newCard);
        showToast('Product updated!');
      } else {
        const card = createCard(p);
        grid.prepend(card);
        showToast('Product added!');
      }
      
      modal.close();
      if (grid.children.length > 0) emptyState.classList.add('hidden');
    } catch (err) {
      showToast(err.message, 'error');
    }
  };

  // === EDIT & DELETE HANDLERS ===
  grid.addEventListener('click', async e => {
    const btn = e.target.closest('button');
    if (!btn) return;
    
    const id = btn.dataset.id;
    const card = btn.closest('.product-card');

    if (btn.classList.contains('edit-btn')) {
      try {
        await loadCategories();
        const res = await fetch(`/api/products/${id}`);
        const p = await res.json();

        document.getElementById('product-id').value = p.id;
        document.getElementById('product-name').value = p.name;
        document.getElementById('product-price').value = p.price;
        document.getElementById('product-stock').value = p.stock;
        document.getElementById('product-description').value = p.description || '';
        categorySelect.value = p.category_id || '';

        const imgDiv = document.getElementById('current-image');
        if (p.image) {
          imgDiv.innerHTML = `<img src="/static/uploads/${p.image}" class="h-24 rounded-lg shadow-md mt-2">`;
        } else {
          imgDiv.innerHTML = '<p class="text-sm text-gray-500 mt-2">No image</p>';
        }

        modal.showModal();
      } catch (err) {
        showToast('Failed to load product', 'error');
      }

    } else if (btn.classList.contains('delete-btn')) {
      if (!confirm('Delete this product? This cannot be undone.')) return;

      try {
        const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');

        // Animate out
        card.style.transition = 'all 0.4s ease';
        card.style.opacity = '0';
        card.style.transform = 'scale(0.9)';
        card.style.marginBottom = '-100px';

        setTimeout(() => {
          card.remove();
          showToast('Product deleted!');
          if (grid.children.length === 0) {
            emptyState.classList.remove('hidden');
          }
        }, 400);
      } catch (err) {
        showToast(err.message, 'error');
      }
    }
  });

  // === INITIAL LOAD ===
  loadProducts();
</script>

{% endblock %}