{% extends 'base.html' %}
{% block title %}Products{% endblock %}
{% block content %}
<div class="flex justify-between items-center mb-6">
  <h1 class="text-3xl font-bold text-gray-800">Products</h1>
  <button id="open-add-modal" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Product</button>
</div>

<div id="products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>

<dialog id="product-modal">
  <form id="product-form" enctype="multipart/form-data" class="space-y-4 p-4">
    <input type="hidden" id="product-id">
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
      <input id="product-name" name="name" required class="w-full border border-gray-300 rounded-md px-3 py-2">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
      <input id="product-price" name="price" type="number" step="0.01" required class="w-full border border-gray-300 rounded-md px-3 py-2">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Stock</label>
      <input id="product-stock" name="stock" type="number" required class="w-full border border-gray-300 rounded-md px-3 py-2">
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
      <select id="product-category" name="category_id" class="w-full border border-gray-300 rounded-md px-3 py-2">
        <option value="">None</option>
      </select>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
      <textarea id="product-description" name="description" class="w-full border border-gray-300 rounded-md px-3 py-2"></textarea>
    </div>
    <div>
      <label class="block text-sm font-medium text-gray-700 mb-1">Image</label>
      <input type="file" name="image" accept="image/*" class="w-full border border-gray-300 rounded-md px-3 py-2">
      <div id="current-image" class="mt-2"></div>
    </div>
    <div class="flex justify-end gap-2">
      <button type="button" id="cancel-modal" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">Cancel</button>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save</button>
    </div>
  </form>
</dialog>

<script>
  const modal = document.getElementById('product-modal');
  const form = document.getElementById('product-form');
  const grid = document.getElementById('products-grid');
  const openAdd = document.getElementById('open-add-modal');
  const cancel = document.getElementById('cancel-modal');
  const categorySelect = document.getElementById('product-category');

  async function loadCategories() {
    const res = await fetch('/api/categories');
    const cats = await res.json();
    categorySelect.innerHTML = '<option value="">None</option>';
    cats.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id; opt.textContent = c.name;
      categorySelect.appendChild(opt);
    });
  }

  async function loadProducts() {
    const res = await fetch('/api/products');
    const prods = await res.json();
    grid.innerHTML = '';
    prods.forEach(p => grid.appendChild(createCard(p)));
  }

  function createCard(p) {
    const div = document.createElement('div');
    div.className = 'card bg-white rounded-xl shadow-md p-6 animate-scale-in relative';
    div.dataset.id = p.id;
    div.innerHTML = `
      <img src="${p.image_url}" alt="${p.name}" class="w-full h-40 object-cover rounded-lg mb-3" onerror="this.src='/static/no-image.png'">
      <h3 class="text-xl font-semibold text-gray-800 mb-2">${p.name}</h3>
      <p class="text-2xl font-bold text-green-600 mb-1">$${p.price.toFixed(2)}</p>
      <p class="text-sm text-gray-600 mb-1">Stock: <span class="font-medium">${p.stock}</span></p>
      <p class="text-sm text-gray-600 mb-1">Category: ${p.category_name}</p>
      <p class="text-sm text-gray-500 mb-4">${p.description.substring(0,60)}...</p>
      <div class="flex gap-2">
        <button data-id="${p.id}" class="edit-btn bg-yellow-500 text-white px-3 py-1 rounded flex-1 hover:bg-yellow-600">Edit</button>
        <button data-id="${p.id}" class="delete-btn bg-red-600 text-white px-3 py-1 rounded flex-1 hover:bg-red-700">Delete</button>
      </div>
    `;
    return div;
  }

  openAdd.onclick = async () => { await loadCategories(); form.reset(); categorySelect.value = ''; document.getElementById('product-id').value = ''; document.getElementById('current-image').innerHTML = ''; modal.showModal(); };
  cancel.onclick = () => modal.close();

  form.onsubmit = async e => {
    e.preventDefault();
    const id = document.getElementById('product-id').value;
    const formData = new FormData(form);
    const method = id ? 'PUT' : 'POST';
    const url = id ? `/api/products/${id}` : '/api/products';
    const res = await fetch(url, { method, body: formData });
    if (res.ok) {
      const p = await res.json();
      if (id) {
        const card = grid.querySelector(`[data-id="${id}"]`);
        card.replaceWith(createCard(p));
      } else {
        grid.appendChild(createCard(p));
      }
      modal.close();
    }
  };

  grid.addEventListener('click', async e => {
    const btn = e.target;
    const id = btn.dataset.id;
    const card = btn.closest('[data-id]');
    if (btn.classList.contains('edit-btn')) {
      await loadCategories();
      const res = await fetch(`/api/products/${id}`);
      const p = await res.json();
      document.getElementById('product-id').value = p.id;
      document.getElementById('product-name').value = p.name;
      document.getElementById('product-price').value = p.price;
      document.getElementById('product-stock').value = p.stock;
      document.getElementById('product-description').value = p.description;
      categorySelect.value = p.category_id || '';
      const currentImg = document.getElementById('current-image');
      if (p.image) {
        currentImg.innerHTML = `<img src="${p.image_url}" class="h-20 rounded mt-2">`;
      } else {
        currentImg.innerHTML = '<p class="text-sm text-gray-500">No image</p>';
      }
      modal.showModal();
    } else if (btn.classList.contains('delete-btn')) {
      if (confirm('Delete this product?')) {
        await fetch(`/api/products/${id}`, { method: 'DELETE' });
        card.remove();
      }
    }
  });

  loadProducts();
</script>
{% endblock %}